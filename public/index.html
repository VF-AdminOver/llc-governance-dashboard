<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLC Governance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn { border-radius: 25px; padding: 10px 20px; font-weight: 600; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="loginSection" class="container-fluid d-flex align-items-center justify-content-center min-vh-100">
        <div class="card p-5 w-100" style="max-width: 400px;">
            <div class="card-body text-center">
                <h1 class="card-title mb-4">üè† LLC Governance Dashboard</h1>

                <!-- Login Form -->
                <form id="loginForm">
                    <div class="mb-3">
                        <input type="text" id="username" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="mb-3">
                        <input type="password" id="password" class="form-control" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>

                <button id="showRegisterBtn" class="btn btn-link mt-3">Register New Account</button>

                <!-- Registration Form (Hidden by default) -->
                <form id="registerForm" style="display: none;">
                    <hr class="my-3">
                    <h5>Create Account</h5>
                    <div class="mb-3">
                        <input type="text" id="regUsername" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="mb-3">
                        <input type="password" id="regPassword" class="form-control" placeholder="Password" required>
                    </div>
                    <div class="mb-3">
                        <select id="regRole" class="form-select">
                            <option value="member">Member</option>
                            <option value="admin">Admin</option>
                            <option value="youth">Youth</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Register</button>
                    <button type="button" id="cancelRegisterBtn" class="btn btn-link mt-2">Cancel</button>
                </form>

                <div id="authMessage" class="mt-3"></div>
                <div class="mt-3 small text-muted">
                    <em>OAuth login requires Google API credentials setup.</em>
        </div>

        <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-bottom">
            <div class="container">
                <a class="navbar-brand" href="#">üè† LLC Governance Dashboard</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('household')">Household</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('ownership')">Ownership</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('assets')">Assets</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('voting')">Voting</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('dividends')">Dividends</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('documents')">Documents</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('rules')">Rules</a>
                        </li>
                    </ul>
                    <span class="navbar-text" id="userInfo"></span>
                    <button class="btn btn-outline-light ms-3" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>
    </div>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <div class="container mt-4">
            <div id="householdTab" class="tab-content">
                <h3>üë• Household Management</h3>
                <div id="householdContent"></div>
            </div>

            <div id="ownershipTab" class="tab-content hidden">
                <h3>üìà Ownership Ledger</h3>
                <div id="ownershipContent"></div>
            </div>

            <div id="assetsTab" class="tab-content hidden">
                <h3>üè¢ Asset Register</h3>
                <div id="assetsContent"></div>
            </div>

            <div id="votingTab" class="tab-content hidden">
                <h3>üó≥Ô∏è Voting Portal</h3>
                <div id="votingContent"></div>
            </div>

            <div id="dividendsTab" class="tab-content hidden">
                <h3>üí∞ Dividend Tracker</h3>
                <div id="dividendsContent"></div>
            </div>

            <div id="documentsTab" class="tab-content hidden">
                <h3>üìÑ Document Vault</h3>
                <div id="documentsContent"></div>
            </div>

            <div id="rulesTab" class="tab-content hidden">
                <h3>üìú Governance Rules</h3>
                <div id="rulesContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('LLC Governance Dashboard JS loaded');
        let currentUser = null;
        let currentHousehold = null;

        // Check if logged in on load
        window.onload = function() {
            console.log('Window onload triggered');
            checkAuth();
        };

        function checkAuth() {
            fetch('/api/me')
                .then(response => response.json())
                .then(user => {
                    if (user.id) {
                        currentUser = user;
                        showDashboard();
                    }
                })
                .catch(() => showLogin());
        }

        function showLogin() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `${currentUser.username} (${currentUser.role})`;

            // Show login success message
            showToast('Login successful! Welcome to LLC Governance Dashboard.', 'success');

            showTab('household');
        }

        function showToast(message, type) {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.innerHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toastContainer);

            const toastElement = toastContainer.querySelector('.toast');
            const toast = new bootstrap.Toast(toastElement);
            toast.show();

            // Remove after shown
            setTimeout(() => {
                document.body.removeChild(toastContainer);
            }, 5000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            switch(tabName) {
                case 'household': loadHousehold(); break;
                case 'ownership': loadOwnership(); break;
                case 'assets': loadAssets(); break;
                case 'voting': loadVoting(); break;
                case 'dividends': loadDividends(); break;
                case 'documents': loadDocuments(); break;
                case 'rules': loadRules(); break;
            }
        }

        // Auth functions
        console.log('Setting up login form listener');
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            console.log('Login form submitted');
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            console.log('Login attempt:', username, password ? '[password]' : 'no password');

            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => {
                console.log('Login response status:', response.status);
                return response.json();
            })
            .then(result => {
                console.log('Login result:', result);
                if (result.id) {
                    currentUser = result;
                    showDashboard();
                } else {
                    document.getElementById('authMessage').innerHTML = '<div class="alert alert-danger">' + result.error + '</div>';
                }
            })
            .catch(error => {
                console.error('Login error:', error);
                document.getElementById('authMessage').innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
            });
        });

        // Show registration form
        document.getElementById('showRegisterBtn').addEventListener('click', function() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('showRegisterBtn').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        });

        // Cancel registration
        document.getElementById('cancelRegisterBtn').addEventListener('click', function() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('showRegisterBtn').style.display = 'block';
        });

        // Registration form
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('regRole').value;

            if (username && password) {
                fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.id) {
                        document.getElementById('authMessage').innerHTML = '<div class="alert alert-success">Registered successfully! Please login.</div>';
                        document.getElementById('cancelRegisterBtn').click(); // Go back to login
                    } else {
                        document.getElementById('authMessage').innerHTML = '<div class="alert alert-danger">' + result.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('authMessage').innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
                });
            }
        });

        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    currentUser = null;
                    showLogin();
                });
        }

        // Household functions
        function loadHousehold() {
            fetch('/api/households')
                .then(response => response.json())
                .then(households => {
                    if (households.length > 0) {
                        currentHousehold = households[0];
                        displayHousehold();
                    } else {
                        document.getElementById('householdContent').innerHTML = '<p>No household assigned. Contact admin.</p>';
                    }
                });
        }

        function displayHousehold() {
            let html = `<h4>${currentHousehold.name}</h4>`;
            // Members
            html += '<h5>Members</h5><ul class="list-group mb-3">';
            currentHousehold.members.forEach(member => {
                html += `<li class="list-group-item">${member.name} - ${member.units} units (${member.ownership_percentage}% ownership)</li>`;
            });
            html += '</ul>';
            document.getElementById('householdContent').innerHTML = html;
        }

        // Ownership functions
        function loadOwnership() {
            fetch('/api/contributions')
                .then(response => response.json())
                .then(contributions => {
                    let html = '<button class="btn btn-success mb-3" onclick="addContribution()">Add Contribution</button>';
                    html += '<table class="table"><thead><tr><th>Date</th><th>Member</th><th>Type</th><th>Description</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
                    contributions.forEach(c => {
                        html += `<tr><td>${c.date}</td><td>${c.member_name}</td><td>${c.type}</td><td>${c.description}</td><td>$${c.amount}</td><td>${c.status}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('ownershipContent').innerHTML = html;
                });
        }

        function addContribution() {
            const type = prompt('Type (capital/sweat):');
            const description = prompt('Description:');
            const amount = prompt('Amount:');
            if (type && description) {
                fetch('/api/contributions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, description, amount: parseFloat(amount) })
                })
                .then(() => loadOwnership());
            }
        }

        // Assets functions
        function loadAssets() {
            fetch('/api/assets')
                .then(response => response.json())
                .then(assets => {
                    let html = '<button class="btn btn-success mb-3" onclick="addAsset()">Add Asset</button>';
                    html += '<table class="table"><thead><tr><th>Name</th><th>Type</th><th>Value</th><th>Status</th></tr></thead><tbody>';
                    assets.forEach(asset => {
                        html += `<tr><td>${asset.name}</td><td>${asset.type}</td><td>$${asset.value}</td><td>${asset.status}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('assetsContent').innerHTML = html;
                });
        }

        function addAsset() {
            const name = prompt('Asset Name:');
            const type = prompt('Type:');
            const value = prompt('Value:');
            if (name && type && value) {
                fetch('/api/assets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, type, value: parseFloat(value) })
                })
                .then(() => loadAssets());
            }
        }

        // Voting functions
        function loadVoting() {
            fetch('/api/proposals')
                .then(response => response.json())
                .then(proposals => {
                    let html = '<button class="btn btn-success mb-3" onclick="createProposal()">Create Proposal</button>';
                    html += '<div class="row">';
                    proposals.forEach(proposal => {
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">${proposal.title}</h5>
                                        <p class="card-text">${proposal.description}</p>
                                        <button class="btn btn-primary" onclick="viewProposal(${proposal.id})">View & Vote</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('votingContent').innerHTML = html;
                });
        }

        function createProposal() {
            const title = prompt('Proposal Title:');
            const description = prompt('Description:');
            if (title && description) {
                fetch('/api/proposals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, options: ['Yes', 'No'] })
                })
                .then(() => loadVoting());
            }
        }

        function viewProposal(id) {
            fetch(`/api/proposals/${id}`)
                .then(response => response.json())
                .then(proposal => {
                    let html = `<h4>${proposal.title}</h4><p>${proposal.description}</p>`;
                    html += '<button class="btn btn-outline-primary m-1" onclick="vote(' + proposal.id + ', \'Yes\')">Yes</button>';
                    html += '<button class="btn btn-outline-primary m-1" onclick="vote(' + proposal.id + ', \'No\')">No</button>';
                    if (proposal.results) {
                        html += `<h5>Results: ${proposal.results.passed ? 'Passed' : 'Failed'}</h5>`;
                    }
                    document.getElementById('votingContent').innerHTML = html;
                });
        }

        function vote(proposalId, option) {
            fetch(`/api/proposals/${proposalId}/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vote: option })
            })
            .then(() => viewProposal(proposalId));
        }

        // Dividends functions
        function loadDividends() {
            fetch('/api/dividends')
                .then(response => response.json())
                .then(dividends => {
                    let html = '<button class="btn btn-success mb-3" onclick="createDividend()">Create Dividend</button>';
                    html += '<table class="table"><thead><tr><th>Date</th><th>Amount</th><th>Description</th></tr></thead><tbody>';
                    dividends.forEach(dividend => {
                        html += `<tr><td>${new Date(dividend.distribution_date).toLocaleDateString()}</td><td>$${dividend.amount}</td><td>${dividend.description}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('dividendsContent').innerHTML = html;
                });
        }

        function createDividend() {
            const amount = prompt('Dividend Amount:');
            const description = prompt('Description:');
            if (amount && description) {
                fetch('/api/dividends', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseFloat(amount), description })
                })
                .then(() => loadDividends());
            }
        }

        // Documents functions
        function loadDocuments() {
            fetch('/api/documents')
                .then(response => response.json())
                .then(documents => {
                    let html = '<input type="file" id="fileInput" class="form-control mb-3"><button class="btn btn-success" onclick="uploadDocument()">Upload</button>';
                    html += '<table class="table"><thead><tr><th>Name</th><th>Uploaded</th><th>Action</th></tr></thead><tbody>';
                    documents.forEach(doc => {
                        html += `<tr><td>${doc.name}</td><td>${new Date(doc.uploaded_date).toLocaleDateString()}</td><td><button class="btn btn-primary btn-sm" onclick="downloadDocument(${doc.id})">Download</button></td></tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('documentsContent').innerHTML = html;
                });
        }

        function uploadDocument() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result.split(',')[1];
                    fetch('/api/documents', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: file.name,
                            data: data,
                            contentType: file.type
                        })
                    })
                    .then(() => loadDocuments());
                };
                reader.readAsDataURL(file);
            }
        }

        function downloadDocument(id) {
            window.open(`/api/documents/${id}/download`);
        }

        // Rules functions
        function loadRules() {
            fetch('/api/governance-rules')
                .then(response => response.json())
                .then(rules => {
                    let html = '<button class="btn btn-success mb-3" onclick="addRule()">Add Rule</button>';
                    html += '<table class="table"><thead><tr><th>Name</th><th>Type</th><th>Active</th></tr></thead><tbody>';
                    rules.forEach(rule => {
                        html += `<tr><td>${rule.rule_name}</td><td>${rule.rule_type}</td><td>${rule.is_active ? 'Yes' : 'No'}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('rulesContent').innerHTML = html;
                });
        }

        function addRule() {
            const name = prompt('Rule Name:');
            const type = prompt('Type:');
            if (name && type) {
                fetch('/api/governance-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ruleName: name, ruleType: type, conditions: {}, actions: {} })
                })
                .then(() => loadRules());
            }
        }
    </script>
</body>
</html>